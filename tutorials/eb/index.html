
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Fitting a detached eclipsing binary &#8212; exoplanet</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/exoplanet.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../../_static/documentation_options.js?v=37838749"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tutorials/eb';</script>
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="RVs with multiple instruments" href="../rv-multi/" />
    <link rel="prev" title="Fitting transit times" href="../ttv/" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search/"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../../">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="exoplanet - Home"/>
    <script>document.write(`<img src="../../_static/logo.png" class="logo__image only-dark" alt="exoplanet - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../rv/">Radial velocity fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../transit/">Transit fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../astrometric/">Astrometric fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stellar-variability/">Gaussian process models for stellar variability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../joint/">Joint RV &amp; transit fits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tess/">Fitting TESS data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick-tess/">Quick fits for TESS light curves</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lc-gp-transit/">Simultaneous Fitting of a Transit with Stellar Variability</a></li>



<li class="toctree-l1"><a class="reference internal" href="../ttv/">Fitting transit times</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Fitting a detached eclipsing binary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rv-multi/">RVs with multiple instruments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lc-multi/">Light curves from multiple instruments</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.exoplanet.codes">Main exoplanet docs</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/exoplanet-dev/case-studies/main?urlpath=lab/tree/docs/tutorials/eb.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/exoplanet-dev/case-studies" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/exoplanet-dev/case-studies/edit/main/docs/tutorials/eb.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/exoplanet-dev/case-studies/issues/new?title=Issue%20on%20page%20%2Ftutorials/eb.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/tutorials/eb.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Fitting a detached eclipsing binary</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-access">Data access</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#probabilistic-model">Probabilistic model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sampling">Sampling</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#results">Results</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-note-about-eccentricities">A note about eccentricities</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#citations">Citations</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="fitting-a-detached-eclipsing-binary">
<span id="eb"></span><h1>Fitting a detached eclipsing binary<a class="headerlink" href="#fitting-a-detached-eclipsing-binary" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">exoplanet</span>

<span class="n">exoplanet</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">docs_setup</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;exoplanet.__version__ = &#39;</span><span class="si">{</span><span class="n">exoplanet</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>exoplanet.__version__ = &#39;0.5.4.dev27+g75d7fcc&#39;
</pre></div>
</div>
</div>
</div>
<p>In this case study, we’ll go through the steps required to fit the light curve and radial velocity measurements for the detached eclipsing binary system HD 23642.
This is a bright system that has been fit by many authors (<a class="reference external" href="https://arxiv.org/abs/astro-ph/0403444">1</a>, <a class="reference external" href="https://arxiv.org/abs/astro-ph/0409507">2</a>, <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2007A%26A...463..579G/abstract">3</a>, <a class="reference external" href="https://arxiv.org/abs/1602.01901">4</a>, and <a class="reference external" href="https://arxiv.org/abs/1603.08484">5</a> to name a few) so this is a good benchmark for our demonstration.</p>
<p>The light curve that we’ll use is from K2 and we’ll use the same radial velocity measurements as <a class="reference external" href="https://arxiv.org/abs/1602.01901">David+ (2016)</a> compiled from <a class="reference external" href="https://arxiv.org/abs/astro-ph/0403444">here</a> and <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2007A%26A...463..579G/abstract">here</a>.
We’ll use a somewhat simplified model for the eclipses that treats the stars as spherical and ignores the phase curve (we’ll model it using a Gaussian process instead of a more physically motivated model).
But, as you’ll see, these simplifying assumptions are sufficient for this case of a detached and well behaved system.
Unlike some previous studies, we will fit an eccentric orbit instead of fixing the eccentricity to zero.
This probably isn’t really necessary here, but it’s useful to demonstrate how you would fit a more eccentric system.
Finally, we model the phase curve and other trends in both the light curve and radial velocities using Gaussian processes.
This will account for unmodeled stellar variability and residual systematics, drifts, and other effects left over from the data reduction procedure.</p>
<section id="data-access">
<h2>Data access<a class="headerlink" href="#data-access" title="Link to this heading">#</a></h2>
<p>First, let’s define some values from the literature that will be useful below.
Here we’re taking the period and eclipse time from <a class="reference external" href="https://arxiv.org/abs/1602.01901">David+ (2016)</a> as initial guesses for these parameters in our fit.
We’ll also include the same prior on the flux ratio of the two stars that was computed for the Kepler bandpass by <a class="reference external" href="https://arxiv.org/abs/1602.01901">David+ (2016)</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lit_period</span> <span class="o">=</span> <span class="mf">2.46113408</span>
<span class="n">lit_t0</span> <span class="o">=</span> <span class="mf">119.522070</span> <span class="o">+</span> <span class="mi">2457000</span> <span class="o">-</span> <span class="mi">2454833</span>

<span class="c1"># Prior on the flux ratio for Kepler</span>
<span class="n">lit_flux_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.354</span><span class="p">,</span> <span class="mf">0.035</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Then we’ll download the Kepler data.
In this case, the pipeline aperture photometry isn’t very good (because this star is so bright!) so we’ll just download the target pixel file and co-add all the pixels.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">lightkurve</span> <span class="k">as</span> <span class="nn">lk</span>

<span class="n">tpf</span> <span class="o">=</span> <span class="n">lk</span><span class="o">.</span><span class="n">search_targetpixelfile</span><span class="p">(</span><span class="s2">&quot;EPIC 211082420&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">download</span><span class="p">()</span>
<span class="n">lc</span> <span class="o">=</span> <span class="n">tpf</span><span class="o">.</span><span class="n">to_lightcurve</span><span class="p">(</span><span class="n">aperture_mask</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
<span class="n">lc</span> <span class="o">=</span> <span class="n">lc</span><span class="o">.</span><span class="n">remove_nans</span><span class="p">()</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>

<span class="n">hdr</span> <span class="o">=</span> <span class="n">tpf</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
<span class="n">texp</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;FRAMETIM&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;NUM_FRM&quot;</span><span class="p">]</span>
<span class="n">texp</span> <span class="o">/=</span> <span class="mf">60.0</span> <span class="o">*</span> <span class="mf">60.0</span> <span class="o">*</span> <span class="mf">24.0</span>

<span class="c1"># To keep things fast for this example, we&#39;re only going to use a third of the data</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">68594</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lc</span><span class="o">.</span><span class="n">time</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mi">3</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">lc</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">lc</span><span class="o">.</span><span class="n">flux</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">/</span> <span class="n">mu</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e3</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">lit_t0</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">lit_period</span><span class="p">)</span> <span class="o">%</span> <span class="n">lit_period</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">lit_period</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s2">&quot;.k&quot;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">lit_period</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">lit_period</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;time since primary eclipse [days]&quot;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;relative flux [ppt]&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/e048081dfbaff6b5e392e018faa4a1c8260ef0f549a3696a9a07436d54d81644.png" src="../../_images/e048081dfbaff6b5e392e018faa4a1c8260ef0f549a3696a9a07436d54d81644.png" />
</div>
</div>
<p>Then we’ll enter the radial velocity data.
I couldn’t find these data online anywhere so I manually transcribed the data from the referenced papers (typos are my own!).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ref1</span> <span class="o">=</span> <span class="mi">2453000</span>
<span class="n">ref2</span> <span class="o">=</span> <span class="mi">2400000</span>
<span class="n">rvs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="c1"># https://arxiv.org/abs/astro-ph/0403444</span>
        <span class="p">(</span><span class="mf">39.41273</span> <span class="o">+</span> <span class="n">ref1</span><span class="p">,</span> <span class="o">-</span><span class="mf">85.0</span><span class="p">,</span> <span class="mf">134.5</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">39.45356</span> <span class="o">+</span> <span class="n">ref1</span><span class="p">,</span> <span class="o">-</span><span class="mf">88.0</span><span class="p">,</span> <span class="mf">139.0</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">39.50548</span> <span class="o">+</span> <span class="n">ref1</span><span class="p">,</span> <span class="o">-</span><span class="mf">91.0</span><span class="p">,</span> <span class="mf">143.0</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">43.25049</span> <span class="o">+</span> <span class="n">ref1</span><span class="p">,</span> <span class="mf">105.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">136.0</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">46.25318</span> <span class="o">+</span> <span class="n">ref1</span><span class="p">,</span> <span class="mf">29.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">24.5</span><span class="p">),</span>
        <span class="c1"># https://ui.adsabs.harvard.edu/abs/2007A%26A...463..579G/abstract</span>
        <span class="p">(</span><span class="mf">52629.6190</span> <span class="o">+</span> <span class="n">ref2</span><span class="p">,</span> <span class="mf">88.8</span><span class="p">,</span> <span class="o">-</span><span class="mf">127.0</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">52630.6098</span> <span class="o">+</span> <span class="n">ref2</span><span class="p">,</span> <span class="o">-</span><span class="mf">48.0</span><span class="p">,</span> <span class="mf">68.0</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">52631.6089</span> <span class="o">+</span> <span class="n">ref2</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.5</span><span class="p">,</span> <span class="mf">13.1</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">52632.6024</span> <span class="o">+</span> <span class="n">ref2</span><span class="p">,</span> <span class="mf">63.6</span><span class="p">,</span> <span class="o">-</span><span class="mf">90.9</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">52633.6162</span> <span class="o">+</span> <span class="n">ref2</span><span class="p">,</span> <span class="o">-</span><span class="mf">94.5</span><span class="p">,</span> <span class="mf">135.0</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">52636.6055</span> <span class="o">+</span> <span class="n">ref2</span><span class="p">,</span> <span class="mf">10.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">13.9</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">52983.6570</span> <span class="o">+</span> <span class="n">ref2</span><span class="p">,</span> <span class="mf">18.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">25.1</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">52987.6453</span> <span class="o">+</span> <span class="n">ref2</span><span class="p">,</span> <span class="o">-</span><span class="mf">80.6</span><span class="p">,</span> <span class="mf">114.5</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">52993.6322</span> <span class="o">+</span> <span class="n">ref2</span><span class="p">,</span> <span class="mf">49.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">70.7</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">53224.9338</span> <span class="o">+</span> <span class="n">ref2</span><span class="p">,</span> <span class="mf">39.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">55.7</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">53229.9384</span> <span class="o">+</span> <span class="n">ref2</span><span class="p">,</span> <span class="mf">57.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">82.0</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">rvs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">2454833</span>
<span class="n">rvs</span> <span class="o">=</span> <span class="n">rvs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">rvs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])]</span>

<span class="n">x_rv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">rvs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">y1_rv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">rvs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">y2_rv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">rvs</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="n">fold</span> <span class="o">=</span> <span class="p">(</span><span class="n">rvs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">lit_t0</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">lit_period</span><span class="p">)</span> <span class="o">%</span> <span class="n">lit_period</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">lit_period</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fold</span><span class="p">,</span> <span class="n">rvs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;primary&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fold</span><span class="p">,</span> <span class="n">rvs</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;secondary&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">lit_period</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">lit_period</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;radial velocity [km / s]&quot;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;time since primary eclipse [days]&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/eccebd1bd101ddc7c9305e19024767e3bc73aaf3e3e20d515502ade6c406cc07.png" src="../../_images/eccebd1bd101ddc7c9305e19024767e3bc73aaf3e3e20d515502ade6c406cc07.png" />
</div>
</div>
</section>
<section id="probabilistic-model">
<h2>Probabilistic model<a class="headerlink" href="#probabilistic-model" title="Link to this heading">#</a></h2>
<p>Then we define the probabilistic model using PyMC3 and exoplanet.
This is similar to the other tutorials and case studies, but here we’re using a <a class="reference external" href="https://docs.exoplanet.codes/en/stable/user/api/#exoplanet.SecondaryEclipseLightCurve">SecondaryEclipseLightCurve</a> to generate the model light curve and we’re modeling the radial velocity trends using a Gaussian process instead of a polynomial.
Otherwise, things should look pretty familiar!</p>
<p>After defining the model, we iteratively clip outliers in the light curve using sigma clipping and then estimate the maximum a posteriori parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pymc3</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="kn">import</span> <span class="nn">aesara_theano_fallback.tensor</span> <span class="k">as</span> <span class="nn">tt</span>

<span class="kn">import</span> <span class="nn">exoplanet</span> <span class="k">as</span> <span class="nn">xo</span>
<span class="kn">import</span> <span class="nn">pymc3_ext</span> <span class="k">as</span> <span class="nn">pmx</span>
<span class="kn">from</span> <span class="nn">celerite2.theano</span> <span class="kn">import</span> <span class="n">terms</span><span class="p">,</span> <span class="n">GaussianProcess</span>


<span class="k">def</span> <span class="nf">build_model</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>
        <span class="c1"># Systemic parameters</span>
        <span class="n">mean_lc</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;mean_lc&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
        <span class="n">mean_rv</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;mean_rv&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mf">50.0</span><span class="p">)</span>
        <span class="n">u1</span> <span class="o">=</span> <span class="n">xo</span><span class="o">.</span><span class="n">QuadLimbDark</span><span class="p">(</span><span class="s2">&quot;u1&quot;</span><span class="p">)</span>
        <span class="n">u2</span> <span class="o">=</span> <span class="n">xo</span><span class="o">.</span><span class="n">QuadLimbDark</span><span class="p">(</span><span class="s2">&quot;u2&quot;</span><span class="p">)</span>

        <span class="c1"># Parameters describing the primary</span>
        <span class="n">log_M1</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;log_M1&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>
        <span class="n">log_R1</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;log_R1&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>
        <span class="n">M1</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;M1&quot;</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_M1</span><span class="p">))</span>
        <span class="n">R1</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;R1&quot;</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_R1</span><span class="p">))</span>

        <span class="c1"># Secondary ratios</span>
        <span class="n">log_k</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;log_k&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>  <span class="c1"># radius ratio</span>
        <span class="n">log_q</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;log_q&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>  <span class="c1"># mass ratio</span>
        <span class="n">log_s</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span>
            <span class="s2">&quot;log_s&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">10.0</span>
        <span class="p">)</span>  <span class="c1"># surface brightness ratio</span>
        <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_k</span><span class="p">))</span>
        <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_q</span><span class="p">))</span>
        <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_s</span><span class="p">))</span>

        <span class="c1"># Prior on flux ratio</span>
        <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span>
            <span class="s2">&quot;flux_prior&quot;</span><span class="p">,</span>
            <span class="n">mu</span><span class="o">=</span><span class="n">lit_flux_ratio</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">sigma</span><span class="o">=</span><span class="n">lit_flux_ratio</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">observed</span><span class="o">=</span><span class="n">tt</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">log_k</span> <span class="o">+</span> <span class="n">log_s</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Parameters describing the orbit</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">xo</span><span class="o">.</span><span class="n">ImpactParameter</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">ror</span><span class="o">=</span><span class="n">tt</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_k</span><span class="p">),</span> <span class="n">testval</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
        <span class="n">log_period</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;log_period&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">lit_period</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">period</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;period&quot;</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_period</span><span class="p">))</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;t0&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">lit_t0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="c1"># Parameters describing the eccentricity: ecs = [e * cos(w), e * sin(w)]</span>
        <span class="n">ecs</span> <span class="o">=</span> <span class="n">pmx</span><span class="o">.</span><span class="n">UnitDisk</span><span class="p">(</span><span class="s2">&quot;ecs&quot;</span><span class="p">,</span> <span class="n">testval</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1e-5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]))</span>
        <span class="n">ecc</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;ecc&quot;</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ecs</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
        <span class="n">omega</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;omega&quot;</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">ecs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ecs</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="c1"># Build the orbit</span>
        <span class="n">R2</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;R2&quot;</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_k</span> <span class="o">+</span> <span class="n">log_R1</span><span class="p">))</span>
        <span class="n">M2</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;M2&quot;</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_q</span> <span class="o">+</span> <span class="n">log_M1</span><span class="p">))</span>
        <span class="n">orbit</span> <span class="o">=</span> <span class="n">xo</span><span class="o">.</span><span class="n">orbits</span><span class="o">.</span><span class="n">KeplerianOrbit</span><span class="p">(</span>
            <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span>
            <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span>
            <span class="n">ecc</span><span class="o">=</span><span class="n">ecc</span><span class="p">,</span>
            <span class="n">omega</span><span class="o">=</span><span class="n">omega</span><span class="p">,</span>
            <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">,</span>
            <span class="n">r_star</span><span class="o">=</span><span class="n">R1</span><span class="p">,</span>
            <span class="n">m_star</span><span class="o">=</span><span class="n">M1</span><span class="p">,</span>
            <span class="n">m_planet</span><span class="o">=</span><span class="n">M2</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Track some other orbital elements</span>
        <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;incl&quot;</span><span class="p">,</span> <span class="n">orbit</span><span class="o">.</span><span class="n">incl</span><span class="p">)</span>
        <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">orbit</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>

        <span class="c1"># Noise model for the light curve</span>
        <span class="n">sigma_lc</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">InverseGamma</span><span class="p">(</span>
            <span class="s2">&quot;sigma_lc&quot;</span><span class="p">,</span>
            <span class="n">testval</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="o">**</span><span class="n">pmx</span><span class="o">.</span><span class="n">estimate_inverse_gamma_parameters</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">sigma_gp</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">InverseGamma</span><span class="p">(</span>
            <span class="s2">&quot;sigma_gp&quot;</span><span class="p">,</span>
            <span class="n">testval</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="o">**</span><span class="n">pmx</span><span class="o">.</span><span class="n">estimate_inverse_gamma_parameters</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">rho_gp</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">InverseGamma</span><span class="p">(</span>
            <span class="s2">&quot;rho_gp&quot;</span><span class="p">,</span>
            <span class="n">testval</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
            <span class="o">**</span><span class="n">pmx</span><span class="o">.</span><span class="n">estimate_inverse_gamma_parameters</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">kernel_lc</span> <span class="o">=</span> <span class="n">terms</span><span class="o">.</span><span class="n">SHOTerm</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="n">sigma_gp</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="n">rho_gp</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Noise model for the radial velocities</span>
        <span class="n">sigma_rv1</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">InverseGamma</span><span class="p">(</span>
            <span class="s2">&quot;sigma_rv1&quot;</span><span class="p">,</span>
            <span class="n">testval</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="o">**</span><span class="n">pmx</span><span class="o">.</span><span class="n">estimate_inverse_gamma_parameters</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">sigma_rv2</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">InverseGamma</span><span class="p">(</span>
            <span class="s2">&quot;sigma_rv2&quot;</span><span class="p">,</span>
            <span class="n">testval</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="o">**</span><span class="n">pmx</span><span class="o">.</span><span class="n">estimate_inverse_gamma_parameters</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">sigma_rv_gp</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">InverseGamma</span><span class="p">(</span>
            <span class="s2">&quot;sigma_rv_gp&quot;</span><span class="p">,</span>
            <span class="n">testval</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
            <span class="o">**</span><span class="n">pmx</span><span class="o">.</span><span class="n">estimate_inverse_gamma_parameters</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">rho_rv_gp</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">InverseGamma</span><span class="p">(</span>
            <span class="s2">&quot;rho_rv_gp&quot;</span><span class="p">,</span>
            <span class="n">testval</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
            <span class="o">**</span><span class="n">pmx</span><span class="o">.</span><span class="n">estimate_inverse_gamma_parameters</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">25.0</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">kernel_rv</span> <span class="o">=</span> <span class="n">terms</span><span class="o">.</span><span class="n">SHOTerm</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="n">sigma_rv_gp</span><span class="p">,</span> <span class="n">w0</span><span class="o">=</span><span class="n">rho_rv_gp</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Set up the light curve model</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="n">xo</span><span class="o">.</span><span class="n">SecondaryEclipseLightCurve</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_s</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">model_lc</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">mean_lc</span>
                <span class="o">+</span> <span class="mf">1e3</span>
                <span class="o">*</span> <span class="n">lc</span><span class="o">.</span><span class="n">get_light_curve</span><span class="p">(</span><span class="n">orbit</span><span class="o">=</span><span class="n">orbit</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">R2</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">texp</span><span class="o">=</span><span class="n">texp</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># Condition the light curve model on the data</span>
        <span class="n">gp_lc</span> <span class="o">=</span> <span class="n">GaussianProcess</span><span class="p">(</span><span class="n">kernel_lc</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">sigma_lc</span><span class="p">)</span>
        <span class="n">gp_lc</span><span class="o">.</span><span class="n">marginal</span><span class="p">(</span><span class="s2">&quot;obs_lc&quot;</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">model_lc</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>

        <span class="c1"># Set up the radial velocity model</span>
        <span class="k">def</span> <span class="nf">model_rv1</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">mean_rv</span> <span class="o">+</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="n">orbit</span><span class="o">.</span><span class="n">get_radial_velocity</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">model_rv2</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">mean_rv</span> <span class="o">-</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="n">orbit</span><span class="o">.</span><span class="n">get_radial_velocity</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">tt</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="o">-</span><span class="n">log_q</span>
            <span class="p">)</span>

        <span class="c1"># Condition the radial velocity model on the data</span>
        <span class="n">gp_rv1</span> <span class="o">=</span> <span class="n">GaussianProcess</span><span class="p">(</span><span class="n">kernel_rv</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">x_rv</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">sigma_rv1</span><span class="p">)</span>
        <span class="n">gp_rv1</span><span class="o">.</span><span class="n">marginal</span><span class="p">(</span><span class="s2">&quot;obs_rv1&quot;</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">y1_rv</span> <span class="o">-</span> <span class="n">model_rv1</span><span class="p">(</span><span class="n">x_rv</span><span class="p">))</span>
        <span class="n">gp_rv2</span> <span class="o">=</span> <span class="n">GaussianProcess</span><span class="p">(</span><span class="n">kernel_rv</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">x_rv</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">sigma_rv2</span><span class="p">)</span>
        <span class="n">gp_rv2</span><span class="o">.</span><span class="n">marginal</span><span class="p">(</span><span class="s2">&quot;obs_rv2&quot;</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">y2_rv</span> <span class="o">-</span> <span class="n">model_rv2</span><span class="p">(</span><span class="n">x_rv</span><span class="p">))</span>

        <span class="c1"># Optimize the logp</span>
        <span class="n">map_soln</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">test_point</span>

        <span class="c1"># First the RV parameters</span>
        <span class="n">map_soln</span> <span class="o">=</span> <span class="n">pmx</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">map_soln</span><span class="p">,</span> <span class="p">[</span><span class="n">mean_rv</span><span class="p">,</span> <span class="n">log_q</span><span class="p">])</span>
        <span class="n">map_soln</span> <span class="o">=</span> <span class="n">pmx</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span>
            <span class="n">map_soln</span><span class="p">,</span> <span class="p">[</span><span class="n">mean_rv</span><span class="p">,</span> <span class="n">sigma_rv1</span><span class="p">,</span> <span class="n">sigma_rv2</span><span class="p">,</span> <span class="n">sigma_rv_gp</span><span class="p">,</span> <span class="n">rho_rv_gp</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Then the LC parameters</span>
        <span class="n">map_soln</span> <span class="o">=</span> <span class="n">pmx</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">map_soln</span><span class="p">,</span> <span class="p">[</span><span class="n">mean_lc</span><span class="p">,</span> <span class="n">log_R1</span><span class="p">,</span> <span class="n">log_k</span><span class="p">,</span> <span class="n">log_s</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>
        <span class="n">map_soln</span> <span class="o">=</span> <span class="n">pmx</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span>
            <span class="n">map_soln</span><span class="p">,</span> <span class="p">[</span><span class="n">mean_lc</span><span class="p">,</span> <span class="n">log_R1</span><span class="p">,</span> <span class="n">log_k</span><span class="p">,</span> <span class="n">log_s</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">map_soln</span> <span class="o">=</span> <span class="n">pmx</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span>
            <span class="n">map_soln</span><span class="p">,</span> <span class="p">[</span><span class="n">mean_lc</span><span class="p">,</span> <span class="n">sigma_lc</span><span class="p">,</span> <span class="n">sigma_gp</span><span class="p">,</span> <span class="n">rho_gp</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">map_soln</span> <span class="o">=</span> <span class="n">pmx</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">map_soln</span><span class="p">,</span> <span class="p">[</span><span class="n">t0</span><span class="p">,</span> <span class="n">log_period</span><span class="p">])</span>

        <span class="c1"># Then all the parameters together</span>
        <span class="n">map_soln</span> <span class="o">=</span> <span class="n">pmx</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">map_soln</span><span class="p">,</span> <span class="p">[</span><span class="n">mean_rv</span><span class="p">,</span> <span class="n">log_q</span><span class="p">,</span> <span class="n">ecs</span><span class="p">])</span>
        <span class="n">map_soln</span> <span class="o">=</span> <span class="n">pmx</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">map_soln</span><span class="p">)</span>

        <span class="n">extras</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span>
            <span class="n">model_lc</span><span class="o">=</span><span class="n">model_lc</span><span class="p">,</span>
            <span class="n">model_rv1</span><span class="o">=</span><span class="n">model_rv1</span><span class="p">,</span>
            <span class="n">model_rv2</span><span class="o">=</span><span class="n">model_rv2</span><span class="p">,</span>
            <span class="n">gp_lc_pred</span><span class="o">=</span><span class="n">gp_lc</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">model_lc</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">])),</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">map_soln</span><span class="p">,</span> <span class="n">extras</span>


<span class="k">def</span> <span class="nf">sigma_clip</span><span class="p">():</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">map_soln</span><span class="p">,</span> <span class="n">extras</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">model</span><span class="p">:</span>
            <span class="n">mdl</span> <span class="o">=</span> <span class="n">pmx</span><span class="o">.</span><span class="n">eval_in_model</span><span class="p">(</span>
                <span class="n">extras</span><span class="p">[</span><span class="s2">&quot;model_lc&quot;</span><span class="p">](</span><span class="n">extras</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="n">extras</span><span class="p">[</span><span class="s2">&quot;gp_lc_pred&quot;</span><span class="p">],</span>
                <span class="n">map_soln</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">resid</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">mdl</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">((</span><span class="n">resid</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">resid</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">resid</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">resid</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">sigma</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sigma clipped </span><span class="si">{0}</span><span class="s2"> light curve points&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num</span> <span class="o">-</span> <span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>
        <span class="k">if</span> <span class="n">num</span> <span class="o">-</span> <span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">map_soln</span><span class="p">,</span> <span class="n">extras</span>


<span class="n">model</span><span class="p">,</span> <span class="n">map_soln</span><span class="p">,</span> <span class="n">extras</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>optimizing logp for variables: [log_q, mean_rv]
</pre></div>
</div>
<div class="output text_html">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div><div class="output text_html">
    <div>
      <progress value='41' class='' max='41' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [41/41 00:00&lt;00:00 logp = -1.306e+04]
    </div>
    </div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>message: Optimization terminated successfully.
logp: -17975.19056073329 -&gt; -13061.232126554985
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>optimizing logp for variables: [rho_rv_gp, sigma_rv_gp, sigma_rv2, sigma_rv1, mean_rv]
</pre></div>
</div>
<div class="output text_html">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div><div class="output text_html">
    <div>
      <progress value='37' class='' max='37' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [37/37 00:00&lt;00:00 logp = -9.681e+03]
    </div>
    </div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>message: Optimization terminated successfully.
logp: -13061.232126554985 -&gt; -9681.173599912336
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>optimizing logp for variables: [b, log_k, log_s, log_R1, mean_lc]
</pre></div>
</div>
<div class="output text_html">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div><div class="output text_html">
    <div>
      <progress value='119' class='' max='119' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [119/119 00:00&lt;00:00 logp = nan]
    </div>
    </div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>message: Desired error not necessarily achieved due to precision loss.
logp: -9681.173599912336 -&gt; nan
final logp not finite, returning initial point
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>this suggests that something is wrong with the model
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>optimizing logp for variables: [u2, u1, b, log_k, log_s, log_R1, mean_lc]
</pre></div>
</div>
<div class="output text_html">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div><div class="output text_html">
    <div>
      <progress value='119' class='' max='119' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [119/119 00:00&lt;00:00 logp = nan]
    </div>
    </div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>message: Desired error not necessarily achieved due to precision loss.
logp: -9681.173599912336 -&gt; nan
final logp not finite, returning initial point
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>this suggests that something is wrong with the model
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>optimizing logp for variables: [rho_gp, sigma_gp, sigma_lc, mean_lc]
</pre></div>
</div>
<div class="output text_html">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div><div class="output text_html">
    <div>
      <progress value='102' class='' max='102' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [102/102 00:00&lt;00:00 logp = -2.782e+03]
    </div>
    </div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>message: Desired error not necessarily achieved due to precision loss.
logp: -9681.173599912336 -&gt; -2782.0945356823468
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>optimizing logp for variables: [log_period, t0]
</pre></div>
</div>
<div class="output text_html">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div><div class="output text_html">
    <div>
      <progress value='44' class='' max='44' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [44/44 00:00&lt;00:00 logp = -2.781e+03]
    </div>
    </div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>message: Desired error not necessarily achieved due to precision loss.
logp: -2782.0945356823468 -&gt; -2780.933505245465
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>optimizing logp for variables: [ecs, log_q, mean_rv]
</pre></div>
</div>
<div class="output text_html">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div><div class="output text_html">
    <div>
      <progress value='31' class='' max='31' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [31/31 00:00&lt;00:00 logp = -2.429e+03]
    </div>
    </div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>message: Optimization terminated successfully.
logp: -2780.933505245465 -&gt; -2428.8731521058053
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>optimizing logp for variables: [rho_rv_gp, sigma_rv_gp, sigma_rv2, sigma_rv1, rho_gp, sigma_gp, sigma_lc, ecs, t0, log_period, b, log_s, log_q, log_k, log_R1, log_M1, u2, u1, mean_rv, mean_lc]
</pre></div>
</div>
<div class="output text_html">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div><div class="output text_html">
    <div>
      <progress value='277' class='' max='277' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [277/277 00:00&lt;00:00 logp = -1.216e+03]
    </div>
    </div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>message: Desired error not necessarily achieved due to precision loss.
logp: -2428.8731521058053 -&gt; -1215.9436577588026
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sigma clipped 12 light curve points
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>optimizing logp for variables: [log_q, mean_rv]
</pre></div>
</div>
<div class="output text_html">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div><div class="output text_html">
    <div>
      <progress value='10' class='' max='10' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [10/10 00:00&lt;00:00 logp = -1.297e+04]
    </div>
    </div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>message: Optimization terminated successfully.
logp: -17888.051068837613 -&gt; -12970.771444043476
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>optimizing logp for variables: [rho_rv_gp, sigma_rv_gp, sigma_rv2, sigma_rv1, mean_rv]
</pre></div>
</div>
<div class="output text_html">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div><div class="output text_html">
    <div>
      <progress value='37' class='' max='37' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [37/37 00:00&lt;00:00 logp = -9.589e+03]
    </div>
    </div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>message: Optimization terminated successfully.
logp: -12970.771444043476 -&gt; -9589.122125143409
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>optimizing logp for variables: [b, log_k, log_s, log_R1, mean_lc]
</pre></div>
</div>
<div class="output text_html">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div><div class="output text_html">
    <div>
      <progress value='28' class='' max='28' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [28/28 00:00&lt;00:00 logp = -4.316e+03]
    </div>
    </div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>message: Optimization terminated successfully.
logp: -9589.122125143409 -&gt; -4316.483140637536
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>optimizing logp for variables: [u2, u1, b, log_k, log_s, log_R1, mean_lc]
</pre></div>
</div>
<div class="output text_html">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div><div class="output text_html">
    <div>
      <progress value='60' class='' max='60' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [60/60 00:00&lt;00:00 logp = -4.228e+03]
    </div>
    </div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>message: Desired error not necessarily achieved due to precision loss.
logp: -4316.483140637536 -&gt; -4227.609496198712
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>optimizing logp for variables: [rho_gp, sigma_gp, sigma_lc, mean_lc]
</pre></div>
</div>
<div class="output text_html">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div><div class="output text_html">
    <div>
      <progress value='31' class='' max='31' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [31/31 00:00&lt;00:00 logp = -1.859e+03]
    </div>
    </div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>message: Optimization terminated successfully.
logp: -4227.609496198712 -&gt; -1858.9804402365323
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>optimizing logp for variables: [log_period, t0]
</pre></div>
</div>
<div class="output text_html">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div><div class="output text_html">
    <div>
      <progress value='46' class='' max='46' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [46/46 00:00&lt;00:00 logp = -1.855e+03]
    </div>
    </div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>message: Desired error not necessarily achieved due to precision loss.
logp: -1858.9804402365323 -&gt; -1854.6790058245117
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>optimizing logp for variables: [ecs, log_q, mean_rv]
</pre></div>
</div>
<div class="output text_html">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div><div class="output text_html">
    <div>
      <progress value='22' class='' max='22' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [22/22 00:00&lt;00:00 logp = -1.734e+03]
    </div>
    </div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>message: Optimization terminated successfully.
logp: -1854.6790058245117 -&gt; -1734.0986558783661
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>optimizing logp for variables: [rho_rv_gp, sigma_rv_gp, sigma_rv2, sigma_rv1, rho_gp, sigma_gp, sigma_lc, ecs, t0, log_period, b, log_s, log_q, log_k, log_R1, log_M1, u2, u1, mean_rv, mean_lc]
</pre></div>
</div>
<div class="output text_html">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div><div class="output text_html">
    <div>
      <progress value='185' class='' max='185' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [185/185 00:00&lt;00:00 logp = -1.032e+03]
    </div>
    </div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>message: Desired error not necessarily achieved due to precision loss.
logp: -1734.0986558783666 -&gt; -1032.4026305829793
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sigma clipped 0 light curve points
</pre></div>
</div>
</div>
</div>
<p>At these maximum a posteriori parameters, let’s make some plots of the model predictions compared to the observations to make sure that things look reasonable.
First the phase-folded radial velocities:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">period</span> <span class="o">=</span> <span class="n">map_soln</span><span class="p">[</span><span class="s2">&quot;period&quot;</span><span class="p">]</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">map_soln</span><span class="p">[</span><span class="s2">&quot;t0&quot;</span><span class="p">]</span>
<span class="n">mean</span> <span class="o">=</span> <span class="n">map_soln</span><span class="p">[</span><span class="s2">&quot;mean_rv&quot;</span><span class="p">]</span>

<span class="n">x_fold</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_rv</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">period</span><span class="p">)</span> <span class="o">%</span> <span class="n">period</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">period</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fold</span><span class="p">,</span> <span class="n">y1_rv</span> <span class="o">-</span> <span class="n">mean</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;primary&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fold</span><span class="p">,</span> <span class="n">y2_rv</span> <span class="o">-</span> <span class="n">mean</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;secondary&quot;</span><span class="p">)</span>

<span class="n">x_phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">period</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">period</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
<span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">y1_mod</span><span class="p">,</span> <span class="n">y2_mod</span> <span class="o">=</span> <span class="n">pmx</span><span class="o">.</span><span class="n">eval_in_model</span><span class="p">(</span>
        <span class="p">[</span><span class="n">extras</span><span class="p">[</span><span class="s2">&quot;model_rv1&quot;</span><span class="p">](</span><span class="n">x_phase</span> <span class="o">+</span> <span class="n">t0</span><span class="p">),</span> <span class="n">extras</span><span class="p">[</span><span class="s2">&quot;model_rv2&quot;</span><span class="p">](</span><span class="n">x_phase</span> <span class="o">+</span> <span class="n">t0</span><span class="p">)],</span>
        <span class="n">map_soln</span><span class="p">,</span>
    <span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_phase</span><span class="p">,</span> <span class="n">y1_mod</span> <span class="o">-</span> <span class="n">mean</span><span class="p">,</span> <span class="s2">&quot;C0&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_phase</span><span class="p">,</span> <span class="n">y2_mod</span> <span class="o">-</span> <span class="n">mean</span><span class="p">,</span> <span class="s2">&quot;C1&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">period</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">period</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;radial velocity [km / s]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;time since primary eclipse [days]&quot;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;HD 23642; map model&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/b697932d125cd07ed0a7044c25d46163f3ee3ee773ecc66b0f4bfad28aad9187.png" src="../../_images/b697932d125cd07ed0a7044c25d46163f3ee3ee773ecc66b0f4bfad28aad9187.png" />
</div>
</div>
<p>And then the light curve.
In the top panel, we show the Gaussian process model for the phase curve.
It’s clear that there’s a lot of information there that we could take advantage of, but that’s a topic for another day.
In the bottom panel, we’re plotting the phase folded light curve and we can see the ridiculous signal to noise that we’re getting on the eclipses.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t_lc_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">3000</span><span class="p">)</span>
<span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">gp_pred</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pmx</span><span class="o">.</span><span class="n">eval_in_model</span><span class="p">(</span><span class="n">extras</span><span class="p">[</span><span class="s2">&quot;gp_lc_pred&quot;</span><span class="p">],</span> <span class="n">map_soln</span><span class="p">)</span> <span class="o">+</span> <span class="n">map_soln</span><span class="p">[</span><span class="s2">&quot;mean_lc&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">lc</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pmx</span><span class="o">.</span><span class="n">eval_in_model</span><span class="p">(</span><span class="n">extras</span><span class="p">[</span><span class="s2">&quot;model_lc&quot;</span><span class="p">](</span><span class="n">t_lc_pred</span><span class="p">),</span> <span class="n">map_soln</span><span class="p">)</span>
        <span class="o">-</span> <span class="n">map_soln</span><span class="p">[</span><span class="s2">&quot;mean_lc&quot;</span><span class="p">]</span>
    <span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">extras</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">extras</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="s2">&quot;k.&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">extras</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">gp_pred</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">extras</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">extras</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">gp_pred</span><span class="p">,</span> <span class="s2">&quot;k.&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_lc_pred</span><span class="p">,</span> <span class="n">lc</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">extras</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">extras</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;raw flux [ppt]&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;de-trended flux [ppt]&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;time [KBJD]&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;HD 23642; map model&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">))</span>

<span class="n">x_fold</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">extras</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">map_soln</span><span class="p">[</span><span class="s2">&quot;t0&quot;</span><span class="p">])</span> <span class="o">%</span> <span class="n">map_soln</span><span class="p">[</span><span class="s2">&quot;period&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">map_soln</span><span class="p">[</span><span class="s2">&quot;period&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">x_fold</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_fold</span><span class="p">[</span><span class="n">inds</span><span class="p">],</span> <span class="n">extras</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">][</span><span class="n">inds</span><span class="p">]</span> <span class="o">-</span> <span class="n">gp_pred</span><span class="p">[</span><span class="n">inds</span><span class="p">],</span> <span class="s2">&quot;k.&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_fold</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">extras</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">][</span><span class="n">inds</span><span class="p">]</span> <span class="o">-</span> <span class="n">gp_pred</span><span class="p">[</span><span class="n">inds</span><span class="p">],</span> <span class="s2">&quot;k.&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">x_fold</span><span class="p">[</span><span class="n">inds</span><span class="p">],</span>
    <span class="n">extras</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">][</span><span class="n">inds</span><span class="p">]</span> <span class="o">-</span> <span class="n">gp_pred</span><span class="p">[</span><span class="n">inds</span><span class="p">],</span>
    <span class="s2">&quot;k.&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;data!&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_fold</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">extras</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">][</span><span class="n">inds</span><span class="p">]</span> <span class="o">-</span> <span class="n">gp_pred</span><span class="p">,</span> <span class="s2">&quot;k.&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="n">yval</span> <span class="o">=</span> <span class="n">extras</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">][</span><span class="n">inds</span><span class="p">]</span> <span class="o">-</span> <span class="n">gp_pred</span>
<span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span>
<span class="n">num</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">x_fold</span><span class="p">[</span><span class="n">inds</span><span class="p">],</span> <span class="n">bins</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">yval</span><span class="p">)</span>
<span class="n">denom</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">x_fold</span><span class="p">[</span><span class="n">inds</span><span class="p">],</span> <span class="n">bins</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span> <span class="o">/</span> <span class="n">denom</span><span class="p">,</span> <span class="s2">&quot;.w&quot;</span><span class="p">)</span>

<span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">x_fold</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_lc_pred</span> <span class="o">-</span> <span class="n">map_soln</span><span class="p">[</span><span class="s2">&quot;t0&quot;</span><span class="p">])</span> <span class="o">%</span> <span class="n">map_soln</span><span class="p">[</span><span class="s2">&quot;period&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">map_soln</span><span class="p">[</span><span class="s2">&quot;period&quot;</span><span class="p">]</span>
<span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">x_fold</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_fold</span><span class="p">[</span><span class="n">inds</span><span class="p">],</span> <span class="n">lc</span><span class="p">[</span><span class="n">inds</span><span class="p">],</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_fold</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lc</span><span class="p">[</span><span class="n">inds</span><span class="p">],</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;de-trended flux [ppt]&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;phase&quot;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;HD 23642; map model&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/e75669bb2c3986347b856a641224f4c9402e7b0358364345d0beab0886ac1ee1.png" src="../../_images/e75669bb2c3986347b856a641224f4c9402e7b0358364345d0beab0886ac1ee1.png" />
<img alt="../../_images/a9861fd76e7f83f3f791275ada6f92d4793bfa6df22057444f10a0fbe9e338f8.png" src="../../_images/a9861fd76e7f83f3f791275ada6f92d4793bfa6df22057444f10a0fbe9e338f8.png" />
</div>
</div>
</section>
<section id="sampling">
<h2>Sampling<a class="headerlink" href="#sampling" title="Link to this heading">#</a></h2>
<p>Finally we can run the MCMC:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">23642</span><span class="p">)</span>
<span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="n">pmx</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="n">tune</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span>
        <span class="n">draws</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="n">map_soln</span><span class="p">,</span>
        <span class="n">cores</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">chains</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">target_accept</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
        <span class="n">return_inferencedata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Multiprocess sampling (2 chains in 2 jobs)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>NUTS: [rho_rv_gp, sigma_rv_gp, sigma_rv2, sigma_rv1, rho_gp, sigma_gp, sigma_lc, ecs, t0, log_period, b, log_s, log_q, log_k, log_R1, log_M1, u2, u1, mean_rv, mean_lc]
</pre></div>
</div>
<div class="output text_html">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div><div class="output text_html">
    <div>
      <progress value='5000' class='' max='5000' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [5000/5000 03:39&lt;00:00 Sampling 2 chains, 0 divergences]
    </div>
    </div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling 2 chains for 1_500 tune and 1_000 draw iterations (3_000 + 2_000 draws total) took 220 seconds.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The number of effective samples is smaller than 25% for some parameters.
</pre></div>
</div>
</div>
</div>
<p>As usual, we can check the convergence diagnostics for some of the key parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;M1&quot;</span><span class="p">,</span> <span class="s2">&quot;M2&quot;</span><span class="p">,</span> <span class="s2">&quot;R1&quot;</span><span class="p">,</span> <span class="s2">&quot;R2&quot;</span><span class="p">,</span> <span class="s2">&quot;ecs&quot;</span><span class="p">,</span> <span class="s2">&quot;incl&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_3%</th>
      <th>hdi_97%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>M1</th>
      <td>2.244</td>
      <td>0.031</td>
      <td>2.189</td>
      <td>2.307</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>1813.0</td>
      <td>956.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>M2</th>
      <td>1.569</td>
      <td>0.025</td>
      <td>1.521</td>
      <td>1.613</td>
      <td>0.001</td>
      <td>0.000</td>
      <td>1782.0</td>
      <td>1461.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>R1</th>
      <td>1.761</td>
      <td>0.036</td>
      <td>1.698</td>
      <td>1.832</td>
      <td>0.002</td>
      <td>0.001</td>
      <td>515.0</td>
      <td>823.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>R2</th>
      <td>1.505</td>
      <td>0.053</td>
      <td>1.409</td>
      <td>1.611</td>
      <td>0.002</td>
      <td>0.001</td>
      <td>694.0</td>
      <td>693.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>ecs[0]</th>
      <td>0.000</td>
      <td>0.000</td>
      <td>-0.000</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>1930.0</td>
      <td>1506.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>ecs[1]</th>
      <td>-0.001</td>
      <td>0.005</td>
      <td>-0.011</td>
      <td>0.009</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>1818.0</td>
      <td>1575.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>incl</th>
      <td>1.365</td>
      <td>0.002</td>
      <td>1.361</td>
      <td>1.370</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>801.0</td>
      <td>777.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>s</th>
      <td>0.479</td>
      <td>0.024</td>
      <td>0.436</td>
      <td>0.524</td>
      <td>0.001</td>
      <td>0.000</td>
      <td>1303.0</td>
      <td>1267.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="results">
<h2>Results<a class="headerlink" href="#results" title="Link to this heading">#</a></h2>
<p>It can be useful to take a look at some diagnostic corner plots to see how the sampling went.
First, let’s look at some observables:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">corner</span>

<span class="n">_</span> <span class="o">=</span> <span class="n">corner</span><span class="o">.</span><span class="n">corner</span><span class="p">(</span>
    <span class="n">trace</span><span class="p">,</span>
    <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;ecs&quot;</span><span class="p">],</span>
    <span class="n">labels</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;$k = R_2 / R_1$&quot;</span><span class="p">,</span>
        <span class="s2">&quot;$q = M_2 / M_1$&quot;</span><span class="p">,</span>
        <span class="s2">&quot;$e\,\cos\omega$&quot;</span><span class="p">,</span>
        <span class="s2">&quot;$e\,\sin\omega$&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/334506cb26b2af3260b894c78819bd670055bb638df9e93498de5bfdb523f688.png" src="../../_images/334506cb26b2af3260b894c78819bd670055bb638df9e93498de5bfdb523f688.png" />
</div>
</div>
<p>And then we can look at the physical properties of the stars in the system.
In this figure, we’re comparing to the results from <a class="reference external" href="https://arxiv.org/abs/1602.01901">David+ (2016)</a> (shown as blue crosshairs).
The orange contours in this figure show the results transformed to a uniform prior on eccentricity as discussed below.
These contours are provided to demonstrate (qualitatively) that these inferences are not sensitive to the choice of prior.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flat_samps</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">sample</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;chain&quot;</span><span class="p">,</span> <span class="s2">&quot;draw&quot;</span><span class="p">))</span>
<span class="n">weights</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">flat_samps</span><span class="p">[</span><span class="s2">&quot;ecc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">weights</span> <span class="o">*=</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">corner</span><span class="o">.</span><span class="n">corner</span><span class="p">(</span>
    <span class="n">trace</span><span class="p">,</span>
    <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;R1&quot;</span><span class="p">,</span> <span class="s2">&quot;R2&quot;</span><span class="p">,</span> <span class="s2">&quot;M1&quot;</span><span class="p">,</span> <span class="s2">&quot;M2&quot;</span><span class="p">],</span>
    <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
    <span class="n">plot_datapoints</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span>
    <span class="n">smooth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">smooth1d</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">corner</span><span class="o">.</span><span class="n">corner</span><span class="p">(</span>
    <span class="n">trace</span><span class="p">,</span>
    <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;R1&quot;</span><span class="p">,</span> <span class="s2">&quot;R2&quot;</span><span class="p">,</span> <span class="s2">&quot;M1&quot;</span><span class="p">,</span> <span class="s2">&quot;M2&quot;</span><span class="p">],</span>
    <span class="n">truths</span><span class="o">=</span><span class="p">[</span><span class="mf">1.727</span><span class="p">,</span> <span class="mf">1.503</span><span class="p">,</span> <span class="mf">2.203</span><span class="p">,</span> <span class="mf">1.5488</span><span class="p">],</span>
    <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/89fec57a8c0e6f283b5b5dbf3d9b6c91683aed2270f0b2e798cccf6c941b21e2.png" src="../../_images/89fec57a8c0e6f283b5b5dbf3d9b6c91683aed2270f0b2e798cccf6c941b21e2.png" />
</div>
</div>
</section>
<section id="a-note-about-eccentricities">
<h2>A note about eccentricities<a class="headerlink" href="#a-note-about-eccentricities" title="Link to this heading">#</a></h2>
<p>If you looked closely at the model defined above, you might have noticed that we chose a slightly odd eccentricity prior: <span class="math notranslate nohighlight">\(p(e) \propto e\)</span>.
This is implied by sampling with <span class="math notranslate nohighlight">\(e\,\cos\omega\)</span> and <span class="math notranslate nohighlight">\(e\,\sin\omega\)</span> as the parameters, as has been discussed many times in the literature.
There are many options for correcting for this prior and instead assuming a uniform prior on eccentricity (for example, sampling with <span class="math notranslate nohighlight">\(\sqrt{e}\,\cos\omega\)</span> and <span class="math notranslate nohighlight">\(\sqrt{e}\,\sin\omega\)</span> as the parameters), but you’ll find much worse sampling performance for this problem if you try any of these options (trust us, we tried!) because the geometry of the posterior surface becomes much less suitable for the sampling algorithm in PyMC3.
Instead, we can re-weight the samples after running the MCMC to see how the results change under the new prior.
Most of the parameter inferences are unaffected by this change (because the data are very constraining!), but the inferred eccentricity (and especially <span class="math notranslate nohighlight">\(e\,\sin\omega\)</span>) will depend on this choice.
The following plots show how these parameter inferences are affected.
Note, especially, how the shape of the <span class="math notranslate nohighlight">\(e\,\sin\omega\)</span> density changes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">esinw</span> <span class="o">=</span> <span class="n">flat_samps</span><span class="p">[</span><span class="s2">&quot;ecc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">flat_samps</span><span class="p">[</span><span class="s2">&quot;omega&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
    <span class="n">esinw</span><span class="p">,</span>
    <span class="mi">50</span><span class="p">,</span>
    <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$p(e) = 2\,e$&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
    <span class="n">esinw</span><span class="p">,</span>
    <span class="mi">50</span><span class="p">,</span>
    <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span>
    <span class="n">weights</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">flat_samps</span><span class="p">[</span><span class="s2">&quot;ecc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$p(e) = 1$&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$e\,\sin(\omega)$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$p(e\,\sin\omega\,|\,\mathrm</span><span class="si">{data}</span><span class="s2">)$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
    <span class="n">flat_samps</span><span class="p">[</span><span class="s2">&quot;ecc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="mi">50</span><span class="p">,</span>
    <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$p(e) = 2\,e$&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
    <span class="n">flat_samps</span><span class="p">[</span><span class="s2">&quot;ecc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="mi">50</span><span class="p">,</span>
    <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span>
    <span class="n">weights</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">flat_samps</span><span class="p">[</span><span class="s2">&quot;ecc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$p(e) = 1$&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$e$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$p(e\,|\,\mathrm</span><span class="si">{data}</span><span class="s2">)$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/2b239f6a11ea58e4cf774bfbbe74b1a1cc3f8f33fe25e2531b318d0881f8cffa.png" src="../../_images/2b239f6a11ea58e4cf774bfbbe74b1a1cc3f8f33fe25e2531b318d0881f8cffa.png" />
<img alt="../../_images/0b581dc06727e375356433ac2689bea4afbb370553763be7b6b4a9b09d841c10.png" src="../../_images/0b581dc06727e375356433ac2689bea4afbb370553763be7b6b4a9b09d841c10.png" />
</div>
</div>
<p>We can then use the <code class="docutils literal notranslate"><span class="pre">corner.quantile</span></code> function to compute summary statistics of the weighted samples as follows.
For example, here how to compute the 90% posterior upper limit for the eccentricity:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">weights</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">flat_samps</span><span class="p">[</span><span class="s2">&quot;ecc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;for p(e) = 2*e: p(e &lt; x) = 0.9 -&gt; x = </span><span class="si">{0:.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">corner</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">flat_samps</span><span class="p">[</span><span class="s2">&quot;ecc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.9</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;for p(e) = 1:   p(e &lt; x) = 0.9 -&gt; x = </span><span class="si">{0:.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">corner</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">flat_samps</span><span class="p">[</span><span class="s2">&quot;ecc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.9</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>for p(e) = 2*e: p(e &lt; x) = 0.9 -&gt; x = 0.00865
for p(e) = 1:   p(e &lt; x) = 0.9 -&gt; x = 0.00370
</pre></div>
</div>
</div>
</div>
<p>Or, the posterior mean and variance for the radius of the primary:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">samples</span> <span class="o">=</span> <span class="n">flat_samps</span><span class="p">[</span><span class="s2">&quot;R1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;for p(e) = 2*e: R1 = </span><span class="si">{0:.3f}</span><span class="s2"> ± </span><span class="si">{1:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">samples</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span> <span class="o">*</span> <span class="n">samples</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span> <span class="o">*</span> <span class="p">(</span><span class="n">samples</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;for p(e) = 1:   R1 = </span><span class="si">{0:.3f}</span><span class="s2"> ± </span><span class="si">{1:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">sigma</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>for p(e) = 2*e: R1 = 1.761 ± 0.036
for p(e) = 1:   R1 = 1.767 ± 0.032
</pre></div>
</div>
</div>
</div>
<p>As you can see (and as one would hope) this choice of prior does not significantly change our inference of the primary radius.</p>
</section>
<section id="citations">
<h2>Citations<a class="headerlink" href="#citations" title="Link to this heading">#</a></h2>
<p>As described in the <a class="reference external" href="https://docs.exoplanet.codes/en/stable/tutorials/citation/">citation tutorial</a>, we can use <a class="reference external" href="https://docs.exoplanet.codes/en/stable/user/api/#exoplanet.citations.get_citations_for_model">citations.get_citations_for_model</a> to construct an acknowledgement and BibTeX listing that includes the relevant citations for this model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">txt</span><span class="p">,</span> <span class="n">bib</span> <span class="o">=</span> <span class="n">xo</span><span class="o">.</span><span class="n">citations</span><span class="o">.</span><span class="n">get_citations_for_model</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>This research made use of \textsf{exoplanet} \citep{exoplanet:joss,
exoplanet:zenodo} and its dependencies \citep{celerite2:foremanmackey17,
celerite2:foremanmackey18, exoplanet:agol20, exoplanet:arviz,
exoplanet:astropy13, exoplanet:astropy18, exoplanet:kipping13,
exoplanet:luger18, exoplanet:pymc3, exoplanet:theano}.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">bib</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">...&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>@article{exoplanet:joss,
       author = {{Foreman-Mackey}, Daniel and {Luger}, Rodrigo and {Agol}, Eric
                and {Barclay}, Thomas and {Bouma}, Luke G. and {Brandt},
                Timothy D. and {Czekala}, Ian and {David}, Trevor J. and
                {Dong}, Jiayin and {Gilbert}, Emily A. and {Gordon}, Tyler A.
                and {Hedges}, Christina and {Hey}, Daniel R. and {Morris},
                Brett M. and {Price-Whelan}, Adrian M. and {Savel}, Arjun B.},
        title = &quot;{exoplanet: Gradient-based probabilistic inference for
                  exoplanet data \&amp; other astronomical time series}&quot;,
      journal = {arXiv e-prints},
         year = 2021,
        month = may,
          eid = {arXiv:2105.01994},
        pages = {arXiv:2105.01994},
archivePrefix = {arXiv},
       eprint = {2105.01994},
 primaryClass = {astro-ph.IM},
       adsurl = {https://ui.adsabs.harvard.edu/abs/2021arXiv210501994F},
      adsnote = {Provided by the SAO/NASA Astrophysics Data System}
}

...
</pre></div>
</div>
</div>
</div>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../ttv/"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Fitting transit times</p>
      </div>
    </a>
    <a class="right-next"
       href="../rv-multi/"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">RVs with multiple instruments</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-access">Data access</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#probabilistic-model">Probabilistic model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sampling">Sampling</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#results">Results</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-note-about-eccentricities">A note about eccentricities</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#citations">Citations</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Dan Foreman-Mackey
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2018, 2019, 2020, 2021, Dan Foreman-Mackey.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>